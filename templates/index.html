<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>テキスト音読AI</title>
  <link rel="stylesheet" href="/static/styles.css" />
</head>
<body>
  <main class="container">
    <h1>テキスト音読AI</h1>
    <p class="desc">テキストを入力し、<b>読み上げ</b>で再生、<b>MP3ダウンロード</b>で保存できます。</p>

    <div class="controls">
      <label class="label">音声</label>
      <select id="voice">
        <!-- Edge TTS の日本語音声例 -->
        <option value="ja-JP-NanamiNeural" selected>Nanami（女性）</option>
        <option value="ja-JP-AoiNeural">Aoi（女性）</option>
        <option value="ja-JP-KeitaNeural">Keita（男性）</option>
      </select>

      <label class="label">話速（-50% ～ +50%）: <span id="rateVal">+0%</span></label>
      <input id="rate" type="range" min="-50" max="50" step="5" value="0" />
    </div>

    <label class="label">テキスト</label>
    <textarea id="text" rows="10" placeholder="ここに読み上げたいテキストを入力してください。"></textarea>
    <div class="row">
      <button id="speakBtn">読み上げ</button>
      <button id="downloadBtn" disabled>MP3ダウンロード</button>
      <button id="clearBtn" class="ghost">クリア</button>
    </div>

    <div id="status" class="status"></div>

    <audio id="player" controls preload="none"></audio>
    <a id="hiddenDownload" style="display:none;"></a>
  </main>

  <script>
    const textEl = document.getElementById("text");
    const rateEl = document.getElementById("rate");
    const rateValEl = document.getElementById("rateVal");
    const voiceEl = document.getElementById("voice");
    const speakBtn = document.getElementById("speakBtn");
    const downloadBtn = document.getElementById("downloadBtn");
    const player = document.getElementById("player");
    const statusEl = document.getElementById("status");
    const hiddenDownload = document.getElementById("hiddenDownload");
    const clearBtn = document.getElementById("clearBtn");

    let lastBlobUrl = null;

    function percentStr(val) {
      return (val >= 0 ? "+" : "") + val + "%";
    }
    rateEl.addEventListener("input", () => {
      rateValEl.textContent = percentStr(Number(rateEl.value));
    });

    async function synthesize(forDownload = false) {
      const text = textEl.value.trim();
      if (!text) {
        statusEl.textContent = "テキストを入力してください。";
        return;
      }
      statusEl.textContent = "合成中…";
      speakBtn.disabled = true;
      downloadBtn.disabled = true;

      const payload = {
        text,
        voice: voiceEl.value,
        rate: percentStr(Number(rateEl.value)),
      };

      try {
        const res = await fetch("/speak", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        if (!res.ok) {
          throw new Error("合成に失敗しました（" + res.status + "）");
        }
        const blob = await res.blob();

        // 古いURLを解放
        if (lastBlobUrl) URL.revokeObjectURL(lastBlobUrl);
        lastBlobUrl = URL.createObjectURL(blob);

        // すぐ再生
        player.src = lastBlobUrl;
        if (!forDownload) {
          try { await player.play(); } catch {}
        }

        // ダウンロードボタンを活性化
        downloadBtn.disabled = false;
        statusEl.textContent = "合成完了";
        return { blob, url: lastBlobUrl };
      } catch (e) {
        console.error(e);
        statusEl.textContent = "エラー: " + e.message;
      } finally {
        speakBtn.disabled = false;
      }
    }

    speakBtn.addEventListener("click", () => synthesize(false));

    downloadBtn.addEventListener("click", async () => {
      // 既に生成済みならそのまま、未生成なら先に合成
      if (!lastBlobUrl) {
        const res = await synthesize(true);
        if (!res) return;
      }
      // a[download]で保存
      const ts = new Date().toISOString().replace(/[-:T.Z]/g, "").slice(0,14);
      hiddenDownload.href = lastBlobUrl;
      hiddenDownload.download = `speech_${ts}.mp3`;
      hiddenDownload.click();
    });

    clearBtn.addEventListener("click", () => {
      textEl.value = "";
      player.removeAttribute("src");
      if (lastBlobUrl) {
        URL.revokeObjectURL(lastBlobUrl);
        lastBlobUrl = null;
      }
      downloadBtn.disabled = true;
      statusEl.textContent = "";
      textEl.focus();
    });
  </script>
</body>
</html>
